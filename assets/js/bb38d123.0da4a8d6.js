"use strict";(globalThis.webpackChunkverilua_docs=globalThis.webpackChunkverilua_docs||[]).push([[934],{183:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>_,contentTitle:()=>r,default:()=>o,frontMatter:()=>i,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"how-to-guides/simple_ut_env","title":"\u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 UT \u73af\u5883","description":"Verilua \u7684\u542f\u52a8\u901f\u5ea6\u5f88\u5feb\uff0c\u5e76\u4e14\u8fd0\u884c\u65f6\u8db3\u591f\u8f7b\u91cf\uff0c\u80fd\u591f\u7528\u6765\u642d\u5efa Unit Test\uff08UT\uff09\u73af\u5883\uff0c\u6d4b\u8bd5\u4e00\u4e9b\u4e2d\u5c0f\u89c4\u6a21\u7684\u786c\u4ef6\u6a21\u5757\u3002","source":"@site/../docs/how-to-guides/simple_ut_env.mdx","sourceDirName":"how-to-guides","slug":"/how-to-guides/simple_ut_env","permalink":"/verilua/docs/how-to-guides/simple_ut_env","draft":false,"unlisted":false,"editUrl":"https://github.com/cyril0124/verilua/tree/master/../docs/how-to-guides/simple_ut_env.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u4e00\u4e2a\u7b80\u5355\u7684 WAL \u793a\u4f8b","permalink":"/verilua/docs/getting-started/simple_wal_example"},"next":{"title":"\u7f16\u5199\u53ef\u590d\u7528\u7684\u9a8c\u8bc1\u7ec4\u4ef6","permalink":"/verilua/docs/how-to-guides/write_reusable_component"}}');var c=t(4848),l=t(8453);const i={},r="\u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 UT \u73af\u5883",_={},a=[{value:"1. \u7f16\u5199 UT \u73af\u5883\u4ee3\u7801",id:"1-\u7f16\u5199-ut-\u73af\u5883\u4ee3\u7801",level:2},{value:"2. \u7f16\u5199 UT \u6d4b\u8bd5\u4e3b\u4f53",id:"2-\u7f16\u5199-ut-\u6d4b\u8bd5\u4e3b\u4f53",level:2},{value:"3. \u7f16\u5199 xmake.lua",id:"3-\u7f16\u5199-xmakelua",level:2},{value:"4. \u6267\u884c\u6d4b\u8bd5",id:"4-\u6267\u884c\u6d4b\u8bd5",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"\u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684-ut-\u73af\u5883",children:"\u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 UT \u73af\u5883"})}),"\n",(0,c.jsx)(n.p,{children:"Verilua \u7684\u542f\u52a8\u901f\u5ea6\u5f88\u5feb\uff0c\u5e76\u4e14\u8fd0\u884c\u65f6\u8db3\u591f\u8f7b\u91cf\uff0c\u80fd\u591f\u7528\u6765\u642d\u5efa Unit Test\uff08UT\uff09\u73af\u5883\uff0c\u6d4b\u8bd5\u4e00\u4e9b\u4e2d\u5c0f\u89c4\u6a21\u7684\u786c\u4ef6\u6a21\u5757\u3002"}),"\n",(0,c.jsxs)(n.p,{children:["\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u57fa\u4e8e Verilua \u642d\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 UT \u73af\u5883\uff0c\u6240\u6709\u7684\u4ee3\u7801\u53ef\u4ee5\u5728",(0,c.jsx)(n.a,{href:"https://github.com/cyril0124/verilua/tree/master/examples/simple_ut_env",children:"\u8fd9\u91cc"}),"\u627e\u5230\u3002"]}),"\n",(0,c.jsx)(n.h2,{id:"1-\u7f16\u5199-ut-\u73af\u5883\u4ee3\u7801",children:"1. \u7f16\u5199 UT \u73af\u5883\u4ee3\u7801"}),"\n",(0,c.jsx)(n.p,{children:"\u6211\u4eec\u53ef\u4ee5\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684 UT \u73af\u5883\u4ee3\u7801\uff0c\u5b83\u5c06\u5305\u542b\u4e00\u4e9b\u5b9e\u9645\u9a8c\u8bc1\u4e2d\u8f83\u4e3a\u5e38\u7528\u7684\u51fd\u6570\uff0c\u5177\u4f53\u53ef\u4ee5\u770b\u4e0b\u9762\u7684\u4ee3\u7801\u7247\u6bb5:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-lua",metastring:'title="env.lua"',children:'local clock = dut.clock:chdl()\nlocal reset = dut.reset:chdl()\n\nlocal function posedge(...)\n    clock:posedge(...)\nend\n\nlocal function negedge(...)\n    clock:negedge(...)\nend\n\nlocal function dut_reset(reset_cycles)\n    reset:set_imm(1)\n    clock:posedge(reset_cycles or 10)\n    reset:set_imm(0)\nend\n\nlocal function expect_happen_until(limit_cycles, func)\n    assert(type(limit_cycles) == "number")\n    assert(type(func) == "function")\n    local ok = clock:posedge_until(limit_cycles, func)\n    assert(ok)\nend\n\nlocal function expect_not_happen_until(limit_cycles, func)\n    assert(type(limit_cycles) == "number")\n    assert(type(func) == "function")\n    local ok = clock:posedge_until(limit_cycles, func)\n    assert(not ok)\nend\n\nlocal test_case_count = 0\n\nlocal function TEST_SUCCESS()\n    print("total_test_cases: <" .. test_case_count .. ">\\n")\n    print(">>>TEST_SUCCESS!<<<")\n\n    local ANSI_GREEN = "\\27[32m"\n    local ANSI_RESET = "\\27[0m"\n\n    print(ANSI_GREEN .. [[\n  _____         _____ _____ \n |  __ \\ /\\    / ____/ ____|\n | |__) /  \\  | (___| (___  \n |  ___/ /\\ \\  \\___ \\\\___ \\ \n | |  / ____ \\ ____) |___) |\n |_| /_/    \\_\\_____/_____/ \n]] .. ANSI_RESET)\n\n    io.flush()\n    sim.finish()\nend\n\n-- \n-- Test case management\n-- \nlocal function register_test_case(case_name)\n    assert(type(case_name) == "string")\n\n    return function(func_table)\n        assert(type(func_table) == "table")\n        assert(#func_table == 1)\n        \n        assert(type(func_table[1]) == "function")\n        local func = func_table[1]\n\n        local new_env = {\n            print = function(...) print("|", ...) end,\n            printf = function(...) io.write("|\\t" .. string.format(...)) end,\n        }\n\n        setmetatable(new_env, { __index = _G })\n        setfenv(func, new_env)\n\n        return function (...)\n            print(string.format([[\n-----------------------------------------------------------------\n| [%d] start test case ==> %s\n-----------------------------------------------------------------]], test_case_count, case_name))\n\n            -- Execute the test case\n            func(...)\n\n            print(string.format([[\n-----------------------------------------------------------------\n| [%d] end test case ==> %s\n-----------------------------------------------------------------]], test_case_count, case_name))\n\n            test_case_count = test_case_count + 1\n        end\n    end\nend\n\nreturn {\n    posedge = posedge,\n    negedge = negedge,\n    dut_reset = dut_reset,\n    expect_happen_until = expect_happen_until,\n    expect_not_happen_until = expect_not_happen_until,\n    register_test_case = register_test_case,\n    TEST_SUCCESS = TEST_SUCCESS,\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u4e0a\u8ff0\u4ee3\u7801\u7247\u6bb5\u63d0\u4f9b\u4e86\u5982\u4e0b\u7684\u51fd\u6570\uff1a"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"env.posedge(...)"})," / ",(0,c.jsx)(n.code,{children:"env.negedge(...)"})]}),"\n",(0,c.jsxs)(n.p,{children:["\u5bf9\u5168\u5c40\u7684 ",(0,c.jsx)(n.code,{children:"clock"})," \u8fd9\u4e2a ",(0,c.jsx)(n.code,{children:"chdl"})," \u7684 ",(0,c.jsx)(n.code,{children:"posedge"})," \u51fd\u6570\u8fdb\u884c\u5c01\u88c5\uff0c\u5176\u4f7f\u7528\u65b9\u5f0f\u548c ",(0,c.jsx)(n.a,{href:"../reference/data_structure#chdl-posedge",children:(0,c.jsx)(n.code,{children:"<chdl>:posedge(...)"})})," / ",(0,c.jsx)(n.a,{href:"../reference/data_structure#chdl-negedge",children:(0,c.jsx)(n.code,{children:"<chdl>:negedge(...)"})})," \u662f\u4e00\u6837\u7684\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.code,{children:"env.dut_reset(reset_cycles)"})}),"\n",(0,c.jsxs)(n.p,{children:["\u5bf9 DUT \u8fdb\u884c\u590d\u4f4d\uff0c\u5176\u4e2d\u4f1a\u5bf9 reset \u4fe1\u53f7\u8fdb\u884c\u8d4b\u503c\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,c.jsx)(n.code,{children:"reset_cycles"})," \u6765\u6307\u5b9a\u590d\u4f4d\u7684\u5468\u671f\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.code,{children:"env.expect_happen_until(limit_cycles, func)"})}),"\n",(0,c.jsxs)(n.p,{children:["\u68c0\u67e5 ",(0,c.jsx)(n.code,{children:"func"})," \u5728 ",(0,c.jsx)(n.code,{children:"limit_cycles"})," \u5468\u671f\u5185\u662f\u5426\u53d1\u751f\uff0c\u5982\u679c\u53d1\u751f\u5219\u7acb\u5373\u8fd4\u56de\uff0c\u5426\u5219\u4f1a\u89e6\u53d1 ",(0,c.jsx)(n.code,{children:"assert"})," \u9519\u8bef\uff0c\u8fd9\u5728\u5177\u4f53\u7f16\u5199\u9a8c\u8bc1\u4ee3\u7801\u7684\u65f6\u5019\u6bd4\u8f83\u5e38\u7528\uff0c\u7528\u6765\u68c0\u67e5\u7279\u5b9a\u4fe1\u53f7\u662f\u5426\u5728\u9884\u671f\u65f6\u95f4\u5185\u53d1\u751f\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.code,{children:"env.expect_not_happen_until(limit_cycles, func)"})}),"\n",(0,c.jsxs)(n.p,{children:["\u548c ",(0,c.jsx)(n.code,{children:"env.expect_happen_until(limit_cycles, func)"})," \u4f5c\u7528\u76f8\u53cd\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.code,{children:"env.TEST_SUCCESS()"})}),"\n",(0,c.jsx)(n.p,{children:"\u7528\u6765\u6253\u5370\u4e00\u4e2a\u663e\u773c\u7684\u4fe1\u606f\u5230 Terminal \u4e0a\uff0c\u8868\u793a\u6d4b\u8bd5\u5df2\u7ecf\u6210\u529f\u7ed3\u675f\u3002"}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.code,{children:"env.register_test_case(case_name)"})}),"\n",(0,c.jsxs)(n.p,{children:["\u6ce8\u518c\u4e00\u4e2a\u6d4b\u8bd5\u7528\u4f8b\uff0c\u5176\u4e2d ",(0,c.jsx)(n.code,{children:"case_name"})," \u662f\u6d4b\u8bd5\u7528\u4f8b\u7684\u540d\u79f0\uff0c\u8fd4\u56de\u4e00\u4e2a\u88ab\u6ce8\u518c\u7684\u6d4b\u8bd5\u7528\u4f8b\u51fd\u6570\u3002\u4f7f\u7528\u793a\u4f8b\u5982\u4e0b\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-lua",children:'local env = require "env"\n\nlocal some_test_case = env.register_test_case "name of the test case" {\n    -- Test case body\n    function ()\n        -- Do something\n    end\n}\n\nfork {\n    function ()\n        env.dut_reset()\n\n        -- Execute the test case\n        some_test_case()\n        \n        env.TEST_SUCCESS()\n        sim.finish()\n    end\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["\u901a\u8fc7\u4e0a\u9762\u8fd9\u4e2a\u7b80\u5355\u7684 ",(0,c.jsx)(n.code,{children:"env.lua"})," \u6a21\u5757\uff0c\u5c31\u80fd\u4e3a UT \u6d4b\u8bd5\u521b\u5efa\u4e00\u4e2a\u7b80\u6613\u7684\u9a8c\u8bc1\u73af\u5883\u3002"]}),"\n",(0,c.jsx)(n.h2,{id:"2-\u7f16\u5199-ut-\u6d4b\u8bd5\u4e3b\u4f53",children:"2. \u7f16\u5199 UT \u6d4b\u8bd5\u4e3b\u4f53"}),"\n",(0,c.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u9700\u8981\u7f16\u5199 UT \u7684\u5177\u4f53\u4e1a\u52a1\u4ee3\u7801\uff08\u4e00\u4e2a lua \u6587\u4ef6\uff09\uff0c\u8fd9\u91cc\u540c\u6837\u4ee5\u4e00\u4e2a Counter \u6a21\u5757\u4e3a\u4f8b\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-verilog",metastring:'title="Counter.v"',children:"module Counter(\n    input  wire clock,\n    input  wire reset,\n    input  wire incr,\n    output wire [7:0] value\n);\n\nreg [7:0] value_reg;\n\nalways@(posedge clock) begin\n    if (reset) \n        value_reg <= 8'd0;\n    else if (incr == 1'b1) begin\n        value_reg <= value_reg + 1'b1;\n    end \nend\n\nassign value = value_reg;\n\nendmodule\n"})}),"\n",(0,c.jsx)(n.p,{children:"\u90a3\u4e48\u4e0a\u8ff0\u8bbe\u8ba1\u7684 UT \u4e1a\u52a1\u4ee3\u7801\u53ef\u4ee5\u5199\u6210\u8fd9\u6837\uff1a"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-lua",metastring:'title="test_counter.lua"',children:'local env = require "env"\n\nlocal test_value_incr = env.register_test_case "test value incr" {\n    function ()\n        env.dut_reset()\n\n        env.posedge()\n            dut.incr:set(1)\n\n        env.posedge()\n            dut.value:expect(0)\n\n        env.posedge()\n            dut.value:expect(1)\n            dut.incr:set(0)\n\n        env.posedge()\n            dut.value:expect(2)\n\n        env.posedge()\n            dut.value:expect(2)\n    end\n}\n\nlocal test_value_no_incr = env.register_test_case "test value no incr" {\n    function ()\n        env.dut_reset()\n\n        env.posedge()\n            dut.incr:set(0)\n\n        env.expect_not_happen_until(1000, function ()\n            return dut.value:is_not(0)\n        end)\n    end\n}\n\nlocal test_value_overflow = env.register_test_case "test value overflow" {\n    function ()\n        env.dut_reset()\n\n        env.posedge()\n            dut.incr:set(1)\n\n        env.expect_happen_until(300, function()\n            return dut.value:get() == 255\n        end)\n    end\n}\n\nfork {\n    function ()\n        env.dut_reset()\n\n        test_value_incr()\n        test_value_no_incr()\n        test_value_overflow()\n\n        env.TEST_SUCCESS()\n        sim.finish()\n    end\n}\n'})}),"\n",(0,c.jsxs)(n.p,{children:["\u8fd9\u91cc\u6211\u4eec\u5199\u4e86\u4e09\u4e2a\u6d4b\u8bd5\u7528\u4f8b\uff1a\uff081\uff09test value incr\uff0c\uff082\uff09test value no incr\uff0c\uff083\uff09test value overflow\u3002\u5e76\u5728 ",(0,c.jsx)(n.code,{children:"fork"})," \u4e2d\u542f\u52a8\u4e86\u8fd9\u4e09\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u3002"]}),"\n",(0,c.jsx)(n.h2,{id:"3-\u7f16\u5199-xmakelua",children:"3. \u7f16\u5199 xmake.lua"}),"\n",(0,c.jsx)(n.p,{children:"\u5bf9\u4e8e HVL \u573a\u666f\uff0c\u6211\u4eec\u90fd\u9700\u8981\u7f16\u5199\u4e00\u4e2a xmake.lua \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-lua",metastring:'title="xmake.lua"',children:'---@diagnostic disable: undefined-global, undefined-field\n\ntarget("test_counter", function()\n    add_rules("verilua")\n\n    local sim = os.getenv("SIM") or "verilator"\n    if sim == "iverilog" then\n        add_toolchains("@iverilog")\n    elseif sim == "vcs" then\n        add_toolchains("@vcs")\n    elseif sim == "xcelium" then\n        add_toolchains("@xcelium")\n    else\n        add_toolchains("@verilator")\n    end\n\n    add_files("env.lua")\n    add_files("Counter.v")\n\n    set_values("cfg.lua_main", "./test_counter.lua")\n    set_values("cfg.top", "Counter")\nend)\n'})}),"\n",(0,c.jsx)(n.h2,{id:"4-\u6267\u884c\u6d4b\u8bd5",children:"4. \u6267\u884c\u6d4b\u8bd5"}),"\n",(0,c.jsx)(n.p,{children:"\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u7f16\u8bd1\u5e76\u8fdb\u884c\u6d4b\u8bd5\uff0c\u8fd9\u91cc\u5982\u679c RTL \u4ee3\u7801\u6ca1\u6709\u4fee\u6539\u5219\u53ea\u9700\u8981\u7f16\u8bd1\u4e00\u6b21\uff0c\u4fee\u6539 Lua \u4ee3\u7801\u5e76\u4e0d\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u3002"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-shell",children:"xmake build -P . test_counter\n\nxmake run -P . test_counter\n"})}),"\n",(0,c.jsxs)(n.p,{children:["\u5982\u679c\u6240\u6709\u7684\u6d4b\u8bd5\u7528\u4f8b\u90fd\u6d4b\u8bd5\u6210\u529f\uff0c\u90a3\u4e48\u5c31\u4f1a\u6253\u5370\u4e00\u4e2a\u6210\u529f\u7684\u63d0\u793a\u4fe1\u606f\uff0c\u5e76\u8c03\u7528 ",(0,c.jsx)(n.code,{children:"sim.finish()"})," \u6765\u7ed3\u675f\u4eff\u771f\u3002\u547d\u4ee4\u884c\u6253\u5370\u7684\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:'language-title="Terminal"',children:"-----------------------------------------------------------------\n| [0] start test case ==> test value incr\n-----------------------------------------------------------------\n-----------------------------------------------------------------\n| [0] end test case ==> test value incr\n-----------------------------------------------------------------\n-----------------------------------------------------------------\n| [1] start test case ==> test value no incr\n-----------------------------------------------------------------\n-----------------------------------------------------------------\n| [1] end test case ==> test value no incr\n-----------------------------------------------------------------\n-----------------------------------------------------------------\n| [2] start test case ==> test value overflow\n-----------------------------------------------------------------\n-----------------------------------------------------------------\n| [2] end test case ==> test value overflow\n-----------------------------------------------------------------\ntotal_test_cases: <3>\n\n>>>TEST_SUCCESS!<<<\n  _____         _____ _____ \n |  __ \\ /\\    / ____/ ____|\n | |__) /  \\  | (___| (___  \n |  ___/ /\\ \\  \\___ \\\\___ \\ \n | |  / ____ \\ ____) |___) |\n |_| /_/    \\_\\_____/_____/ \n\n"})})]})}function o(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var s=t(6540);const c={},l=s.createContext(c);function i(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:i(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);