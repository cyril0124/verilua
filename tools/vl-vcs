#!/usr/bin/env python3

import os
import sys
import subprocess
import base64

RED = "\033[31m"
GREEN = "\033[32m"
YELLOW = "\033[33m"
BLUE = "\033[34m"
RESET = "\033[0m"

def execute_cmd(cmd):
    return subprocess.run(cmd, shell=True, capture_output=True, text=True)

def encode_string(s):
    return base64.b64encode(s.encode()).decode()

def decode_string(s):
    return base64.b64decode(s.encode()).decode()

if os.environ.get("LUAJITPRO_HOME") != None and os.environ.get("VERILUA_USE_NIX") != None:
    luapath = os.environ["LUAJITPRO_HOME"] # This path is set when you install verilua using `nix`
else:
    luapath = verilua_path + "/luajit-pro/luajit2.1"

libpath = os.getenv("VERILUA_HOME") + "/shared"
libpath_lua = luapath + "/lib"
assert libpath != None, "[vl-vcs] cannot find VERILUA_HOME!"
assert os.path.exists(libpath + "/liblua_vpi_vcs.so"), "[vl-vcs] cannot find liblua_vpi_vcs.so in " + libpath

subfix = encode_string(os.path.abspath(os.curdir))
pli_tab = f"/tmp/verilua_{subfix}/pli.tab"
os.system(f"mkdir -p /tmp/verilua_{subfix} && touch {pli_tab}; echo \"acc+=rw,wn:*\" > {pli_tab} ")

vcs = os.getenv("VCS_HOME") + "/bin/vcs"
# cmd_list = [vcs] + sys.argv[1:] + [
#                         # "+acc+1", 
#                         "-debug_access+all", 
#                         # "-CFLAGS", f"\"\"",
#                         "-LDFLAGS", f'-L{libpath_lua} -lluajit-5.1 -L{libpath} -llua_vpi_vcs',
#                         "-load", libpath + "/liblua_vpi_vcs.so", 
#                         "-lluajit-5.1", 
#                         "-llua_vpi_vcs", 
#                         # "-P", pli_tab
# ]

cmd_list = [vcs] + sys.argv[1:] + [
                        "-debug_access+all", 
                        "-LDFLAGS", f'\"-L{libpath}\"', 
                        "-LDFLAGS",  '\"-llua_vpi_vcs\"',
                        "-LDFLAGS", f'\"-L{libpath_lua}\"', 
                        "-LDFLAGS",  '\"-lluajit-5.1\"', 
                        "-LDFLAGS", '\"-lstdc++\"',
                        "-load", libpath + "/liblua_vpi_vcs.so", 
]

cmd = " ".join(cmd_list)

print(f'''
[{YELLOW}vl-vcs{RESET}] cmd:
{GREEN}{cmd}{RESET}
''', flush = True)

exit(subprocess.call(cmd_list))
