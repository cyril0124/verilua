
//VCS coverage exclude_file
// -----------------------------------------
// test bench generated by VERILUA
// -----------------------------------------

// -----------------------------------------
// user custom code
//    use `--custom-code-outer/-cco <file>` to pass in the custom code file.
//       |_ e.g. `testbench_gen [...] --custom-code-outer path/to/file`
//    use `--custom-code-str-outer/-ccso <string>` to pass in the custom code string.
//       |_ e.g. `testbench_gen [...] --custom-code-str-outer "`define a 1"`
// -----------------------------------------




module tb_top #(
parameter integer  VAL = 11,
parameter   MASK = 8'hff,
parameter real  RATIO = 0.75,
parameter string  NAME = "default",
parameter shortint  SHORT_VAL = 16'h1234,
parameter longint  LONG_VAL = 64'h123456789ABCDEF0,
parameter byte  BYTE_VAL = 8'hAB,
parameter  bit [7:0]  BIT_PARAM = 8'hCD,
parameter  logic [15:0]  LOGIC_PARAM = 16'hEF01
)(
`ifdef SIM_VERILATOR
    input wire clock,
    input wire reset,
    output wire [63:0] cycles_o
`endif // SIM_VERILATOR
);


// -----------------------------------------
// macro define check
// -----------------------------------------
`ifdef SIM_VERILATOR
  `ifdef SIM_VCS
    initial begin
      $error("Both SIM_VERILATOR and SIM_VCS are defined. Only one should be defined.");
      $finish;
    end
  `endif
`else
  `ifndef SIM_VCS
    `ifndef SIM_IVERILOG
        initial begin
          $error("One of [SIM_VERILATOR / SIM_VCS / SIM_IVERILOG] is not defined! One must be defined.");
          $finish;
        end
    `endif
  `endif
`endif


// -----------------------------------------
// deal with clock, reset, cycles
// -----------------------------------------
`ifndef SIM_VERILATOR
reg clk;
reg reset;

initial begin
    clk = 0;
    reset = 1;
end

`ifndef NO_INTERNAL_CLOCK
always #10 clk = ~clk;
`endif // NO_INTERNAL_CLOCK
`endif // SIM_VERILATOR


`ifdef SIM_VERILATOR
wire clk;
assign clk = clock;
`else // SIM_VERILATOR
wire clock;
assign clock = clk;
`endif // SIM_VERILATOR





reg [63:0] cycles; // A timestamp counter for simulation, start from 0 and never reset

initial cycles = 0;
always@(posedge clk) begin
    cycles <= cycles + 1; // Increment the timestamp counter every clock cycle
end

`ifdef SIM_VERILATOR
assign cycles_o = cycles; // Tie the timestamp counter to the output port for verilator
`endif

// -----------------------------------------
// reg/wire declaration
// -----------------------------------------
reg i; // input wire i
reg [7:0] i2 [3:0][3:0]; // input wire [7:0] i2 [3:0][3:0]
reg [VAL-1:0] i3 [3:0][VAL-1:0][VAL-1:0]; // input wire [VAL-1:0] i3 [3:0][VAL-1:0][VAL-1:0]
reg i4; // input wire i4
reg i5; // input wire i5
reg [7:0] i6; // input wire [7:0] i6
reg [VAL-1:0] i7 [3:0]; // input wire [VAL-1:0] i7 [3:0]
reg i10; // input wire i10
reg [7:0] i11 [VAL-1:0]; // input wire [7:0] i11 [VAL-1:0]
reg [7:0] i12 [1:0][2:0]; // input wire [7:0] i12 [1:0][2:0]
reg ii1; // input wire ii1
reg ii2; // input wire ii2
reg ii3; // input wire ii3
reg [7:0] ii4; // input wire [7:0] ii4
reg [7:0] ii5; // input wire [7:0] ii5
reg [7:0] ii6; // input wire [7:0] ii6
reg ii7; // input wire ii7
wire [7:0] count0; // output wire [7:0] count0
wire [7:0] count1; // output wire [7:0] count1
wire [VAL-1:0] count2; // output wire [VAL-1:0] count2
wire o; // output wire o
wire o3; // output wire o3
wire o4; // output wire o4
wire [7:0] o5; // output wire [7:0] o5
wire [7:0] o6; // output wire [7:0] o6
wire [7:0] o7; // output wire [7:0] o7
wire [7:0] o8 [3:0]; // output wire [7:0] o8 [3:0]
wire [VAL-1:0] o9 [3:0][VAL-1:0][VAL-1:0]; // output wire [VAL-1:0] o9 [3:0][VAL-1:0][VAL-1:0]
wire [7:0] o10 [0:9]; // output wire [7:0] o10 [0:9]
wire [7:0] oo1; // output wire [7:0] oo1
wire [7:0] oo2; // output wire [7:0] oo2
wire [7:0] oo3; // output wire [7:0] oo3
wire [7:0] oo4; // output wire [7:0] oo4
wire oo5; // output wire oo5
wire sda; // inout wire sda
wire scl; // inout wire scl
wire [7:0] bidir_data; // inout wire [7:0] bidir_data
wire [15:0] bidir_bus; // inout wire [15:0] bidir_bus


// -----------------------------------------
//  reg initialize
// -----------------------------------------
initial begin
    // $display("[INFO] @%0t [%s:%d] hello from tb_top", $time, `__FILE__, `__LINE__);
	i = 0;
	for(int i0 = 0; i0 < (3 - 0 + 1); i0++)
	for(int i1 = 0; i1 < (3 - 0 + 1); i1++)
		i2[i0][i1] = 0;
	for(int i0 = 0; i0 < (3 - 0 + 1); i0++)
	for(int i1 = 0; i1 < (VAL-1 - 0 + 1); i1++)
	for(int i2 = 0; i2 < (VAL-1 - 0 + 1); i2++)
		i3[i0][i1][i2] = 0;
	i4 = 0;
	i5 = 0;
	i6 = 0;
	for(int i0 = 0; i0 < (3 - 0 + 1); i0++)
		i7[i0] = 0;
	i10 = 0;
	for(int i0 = 0; i0 < (VAL-1 - 0 + 1); i0++)
		i11[i0] = 0;
	for(int i0 = 0; i0 < (1 - 0 + 1); i0++)
	for(int i1 = 0; i1 < (2 - 0 + 1); i1++)
		i12[i0][i1] = 0;
	ii1 = 0;
	ii2 = 0;
	ii3 = 0;
	ii4 = 0;
	ii5 = 0;
	ii6 = 0;
	ii7 = 0;
end

// -----------------------------------------
//  DUT module instantiate
// -----------------------------------------
TopNonAnsi #(
.VAL(VAL),
.MASK(MASK),
.RATIO(RATIO),
.NAME(NAME),
.SHORT_VAL(SHORT_VAL),
.LONG_VAL(LONG_VAL),
.BYTE_VAL(BYTE_VAL),
.BIT_PARAM(BIT_PARAM),
.LOGIC_PARAM(LOGIC_PARAM)
) u_TopNonAnsi (
	.clk                            (clk                           ) /* direction: input      dataType: wire */,
	.reset                          (reset                         ) /* direction: input      dataType: wire */,
	.i                              (i                             ) /* direction: input      dataType: wire */,
	.i2                             (i2                            ) /* direction: input      dataType: wire  [7:0] */,
	.i3                             (i3                            ) /* direction: input      dataType: wire  [VAL-1:0] */,
	.i4                             (i4                            ) /* direction: input      dataType: wire */,
	.i5                             (i5                            ) /* direction: input      dataType: wire */,
	.i6                             (i6                            ) /* direction: input      dataType: wire  [7:0] */,
	.i7                             (i7                            ) /* direction: input      dataType: wire  [VAL-1:0] */,
	.i10                            (i10                           ) /* direction: input      dataType: wire */,
	.i11                            (i11                           ) /* direction: input      dataType: wire  [7:0] */,
	.i12                            (i12                           ) /* direction: input      dataType: wire  [7:0] */,
	.ii1                            (ii1                           ) /* direction: input      dataType: wire */,
	.ii2                            (ii2                           ) /* direction: input      dataType: wire */,
	.ii3                            (ii3                           ) /* direction: input      dataType: wire */,
	.ii4                            (ii4                           ) /* direction: input      dataType: wire  [7:0] */,
	.ii5                            (ii5                           ) /* direction: input      dataType: wire  [7:0] */,
	.ii6                            (ii6                           ) /* direction: input      dataType: wire  [7:0] */,
	.ii7                            (ii7                           ) /* direction: input      dataType: wire */,
	.count0                         (count0                        ) /* direction: output     dataType: wire  [7:0] */,
	.count1                         (count1                        ) /* direction: output     dataType: wire  [7:0] */,
	.count2                         (count2                        ) /* direction: output     dataType: wire  [VAL-1:0] */,
	.o                              (o                             ) /* direction: output     dataType: wire */,
	.o3                             (o3                            ) /* direction: output     dataType: wire */,
	.o4                             (o4                            ) /* direction: output     dataType: wire */,
	.o5                             (o5                            ) /* direction: output     dataType: wire  [7:0] */,
	.o6                             (o6                            ) /* direction: output     dataType: wire  [7:0] */,
	.o7                             (o7                            ) /* direction: output     dataType: wire  [7:0] */,
	.o8                             (o8                            ) /* direction: output     dataType: wire  [7:0] */,
	.o9                             (o9                            ) /* direction: output     dataType: wire  [VAL-1:0] */,
	.o10                            (o10                           ) /* direction: output     dataType: wire  [7:0] */,
	.oo1                            (oo1                           ) /* direction: output     dataType: wire  [7:0] */,
	.oo2                            (oo2                           ) /* direction: output     dataType: wire  [7:0] */,
	.oo3                            (oo3                           ) /* direction: output     dataType: wire  [7:0] */,
	.oo4                            (oo4                           ) /* direction: output     dataType: wire  [7:0] */,
	.oo5                            (oo5                           ) /* direction: output     dataType: wire */,
	.sda                            (sda                           ) /* direction: inout      dataType: wire */,
	.scl                            (scl                           ) /* direction: inout      dataType: wire */,
	.bidir_data                     (bidir_data                    ) /* direction: inout      dataType: wire  [7:0] */,
	.bidir_bus                      (bidir_bus                     ) /* direction: inout      dataType: wire  [15:0] */
); // u_TopNonAnsi


// -----------------------------------------
// tracing functions
// https://github.com/chipsalliance/chisel/blob/main/svsim/src/main/scala/Workspace.scala
// -----------------------------------------
`ifndef SIM_IVERILOG
    export "DPI-C" function simulation_initializeTrace;
    export "DPI-C" function simulation_enableTrace;
    export "DPI-C" function simulation_disableTrace;

    function void simulation_initializeTrace;
        input string traceFilePath;

        `ifdef SIM_VERILATOR
            $display("[INFO] @%0t [%s:%d] simulation_initializeTrace trace type => VCD", $time, `__FILE__, `__LINE__);
            $dumpfile({traceFilePath, ".vcd"});
            $dumpvars(0, tb_top);
        `endif // SIM_VERILATOR

        `ifdef SIM_VCS
            `ifdef VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_initializeTrace trace type => VCD", $time, `__FILE__, `__LINE__);
                $dumpfile({traceFilePath, ".vcd"});
                $dumpvars(0, tb_top);
            `else // VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_initializeTrace trace type => FSDB", $time, `__FILE__, `__LINE__);

                `ifdef FSDB_AUTO_SWITCH
                    `ifndef FILE_SIZE
                        `define FILE_SIZE 25
                    `endif

                    `ifndef NUM_OF_FILES
                        `define NUM_OF_FILES 1000
                    `endif

                    $fsdbAutoSwitchDumpfile(`FILE_SIZE, {traceFilePath, ".fsdb"}, `NUM_OF_FILES);
                `else // FSDB_AUTO_SWITCH
                    $fsdbDumpfile({traceFilePath, ".fsdb"});
                `endif // FSDB_AUTO_SWITCH

                `ifdef FSDB_DUMP_SVA
                    //
                    // Dump System Verilog Assertions
                    // Notice: To enable this feature, you also need to add `+fsdb+sva_success`
                    //         to your `./simv` command line args at runtime or in your `vcs`
                    //         command line args at build time.
                    //
                    $fsdbDumpSVA(0, tb_top);
                `endif // FSDB_DUMP_SVA

                //
                // $fsdbDumpvars([depth, instance][, "option"]);
                // options:
                //   +all: Record all signals, including memories, MDA (Memory Data Array), packed arrays, structures, etc.
                //   +mda: Record all memory and MDA signals. MDA (Memory Data Array) signals refer to those related to memory data arrays.
                //   +IO_Only: Record only input and output port signals.
                //   +Reg_Only: Record only signals of register type.
                //   +parameter: Record parameters.
                //   +fsdbfile+filename: Specify the fsdb file name.
                //
                $fsdbDumpvars(0, tb_top, "+all");
            `endif // VCS_DUMP_VCD
        `endif // SIM_VCS
    endfunction

    function void simulation_enableTrace;
        `ifdef SIM_VERILATOR
            $display("[INFO] @%0t [%s:%d] simulation_enableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
            $dumpon;
        `endif

        `ifdef SIM_VCS
            `ifdef VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_enableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
                $dumpon;
            `else // VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_enableTrace trace type => FSDB", $time, `__FILE__, `__LINE__);
                $fsdbDumpon;
                // $fsdbDumpMDA(); // enable dump Multi-Dimension-Array
            `endif // VCS_DUMP_VCD
        `endif
    endfunction

    function void simulation_disableTrace;
        `ifdef SIM_VERILATOR
            $display("[INFO] @%0t [%s:%d] simulation_disableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
            $dumpoff;
        `endif

        `ifdef SIM_VCS
            `ifdef VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_disableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
                $dumpoff;
            `else // VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] simulation_disableTrace trace type => FSDB", $time, `__FILE__, `__LINE__);
                $fsdbDumpoff;
            `endif // VCS_DUMP_VCD
        `endif
    endfunction
`endif // SIM_IVERILOG

`ifdef SIM_IVERILOG
reg simulation_initializeTrace;
reg simulation_initializeTrace_latch;

reg simulation_enableTrace;
reg simulation_enableTrace_latch;

reg simulation_disableTrace;
reg simulation_disableTrace_latch;

initial begin
    simulation_initializeTrace = 0;
    simulation_initializeTrace_latch = 0;

    simulation_enableTrace = 0;
    simulation_enableTrace_latch = 0;

    simulation_disableTrace = 0;
    simulation_disableTrace_latch = 0;
end

always@(posedge clk or negedge clk) begin
    if(simulation_initializeTrace && !simulation_initializeTrace_latch) begin
        integer file;
        string trace_name = "dump.vcd";
        file = $fopen("iverilog_trace_name.txt", "r");
        $fscanf(file, "%s", trace_name);
        $fclose(file);

        $display("[INFO] @%0t [%s:%d] simulation_initializeTrace trace type => VCD", $time, `__FILE__, `__LINE__);
        $dumpfile(trace_name);
        $dumpvars(0, tb_top);

        simulation_initializeTrace_latch <= 1;
    end

    if(simulation_enableTrace && !simulation_enableTrace_latch) begin
        $display("[INFO] @%0t [%s:%d] simulation_enableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
        $dumpon;

        simulation_enableTrace_latch <= 1;
    end

    if(simulation_disableTrace && !simulation_disableTrace_latch) begin
        $display("[INFO] @%0t [%s:%d] simulation_disableTrace trace type => VCD", $time, `__FILE__, `__LINE__);
        $dumpoff;

        simulation_disableTrace_latch <= 1;
    end
end
`endif // SIM_IVERILOG


// -----------------------------------------
// tracing command interface
// -----------------------------------------
`ifdef SIM_VCS
initial begin
    string dump_file = "dump";
    integer dump_start_cycle = 0;

    if ($test$plusargs("dump_enable=1")) begin
        // 1. set dump file name
        // +dump_file=<file_name>
        if ($value$plusargs("dump_file=%s", dump_file))
            $display("[INFO] @%0t [%s:%d] dump_file => %s ", $time, `__FILE__, `__LINE__, dump_file);
        else
            $display("[INFO] @%0t [%s:%d] [default] dump_file => %s ", $time, `__FILE__, `__LINE__, dump_file);

        // 2. set dump start cycle
        // +dump_start_cycle=<cycle_number>
        if ($value$plusargs("dump_start_cycle=%d", dump_start_cycle))
            $display("[INFO] @%0t [%s:%d] dump_start_cycle: %d ", $time, `__FILE__, `__LINE__, dump_start_cycle);

        // 3. set dump type
        // +dump_vcd
        if ($test$plusargs("dump_vcd")) begin
            $display("[INFO] @%0t [%s:%d] enable dump_vcd ", $time, `__FILE__, `__LINE__);

            repeat(dump_start_cycle) @(posedge clk);
            $display("[INFO] @%0t [%s:%d] start dump_vcd at cycle => %d... ", $time, `__FILE__, `__LINE__, dump_start_cycle);

            $dumpfile({dump_file, ".vcd"});
            $dumpvars(0, tb_top);
        // +dump_fsdb
        end else if ($test$plusargs("dump_fsdb")) begin
            `ifndef VCS_DUMP_VCD
                $display("[INFO] @%0t [%s:%d] enable dump_fsdb ", $time, `__FILE__, `__LINE__);

                repeat(dump_start_cycle) @(posedge clk);
                $display("[INFO] @%0t [%s:%d] start dump_fsdb at cycle => %d... ", $time, `__FILE__, `__LINE__, dump_start_cycle);
                $fsdbDumpfile({dump_file, ".fsdb"});
                $fsdbDumpvars(0, tb_top);
            `else // VCS_DUMP_VCD
                $error("VCS_DUMP_VCD is defined, but dump_fsdb is requested. Please check your configuration.");
            `endif // VCS_DUMP_VCD
        end else begin
            $display("[ERROR] @%0t [%s:%d] neither dump_vcd or dump_fsdb are not pass in", $time, `__FILE__, `__LINE__);
            $fatal;
        end
    end
end
`endif // SIM_VCS


// -----------------------------------------
// other user code...
// -----------------------------------------
Others u_others(
  .clock(clk),
  .reset(reset)
);


// -----------------------------------------
// user custom code
//    use `--custom-code/-cc <file>` to pass in the custom code file.
//       |_ e.g. `testbench_gen [...] --custom-code path/to/file`
//    use `--custom-code-str/-ccs <string>` to pass in the custom code string.
//       |_ e.g. `testbench_gen [...] --custom-code-str "reg a; initial a = 1;"`
// -----------------------------------------






endmodule
